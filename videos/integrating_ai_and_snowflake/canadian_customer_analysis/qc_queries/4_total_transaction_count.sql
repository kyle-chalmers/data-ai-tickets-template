-- QC Check 4: Verify total transactions match sum of channels
-- Expected Result: 712,831 total distinct orders

WITH us_customers AS (
    SELECT C_CUSTOMER_SK
    FROM SNOWFLAKE_SAMPLE_DATA.TPCDS_SF10TCL.CUSTOMER
    WHERE C_BIRTH_COUNTRY = 'UNITED STATES'
),
december_2002_dates AS (
    SELECT D_DATE_SK
    FROM SNOWFLAKE_SAMPLE_DATA.TPCDS_SF10TCL.DATE_DIM
    WHERE D_YEAR = 2002 AND D_MOY = 12
)

SELECT
    'Total Distinct Orders Across All Channels' as qc_check,
    (SELECT COUNT(DISTINCT SS_TICKET_NUMBER) FROM SNOWFLAKE_SAMPLE_DATA.TPCDS_SF10TCL.STORE_SALES ss
     INNER JOIN december_2002_dates d ON ss.SS_SOLD_DATE_SK = d.D_DATE_SK
     INNER JOIN us_customers uc ON ss.SS_CUSTOMER_SK = uc.C_CUSTOMER_SK) +
    (SELECT COUNT(DISTINCT WS_ORDER_NUMBER) FROM SNOWFLAKE_SAMPLE_DATA.TPCDS_SF10TCL.WEB_SALES ws
     INNER JOIN december_2002_dates d ON ws.WS_SOLD_DATE_SK = d.D_DATE_SK
     INNER JOIN us_customers uc ON ws.WS_BILL_CUSTOMER_SK = uc.C_CUSTOMER_SK) +
    (SELECT COUNT(DISTINCT CS_ORDER_NUMBER) FROM SNOWFLAKE_SAMPLE_DATA.TPCDS_SF10TCL.CATALOG_SALES cs
     INNER JOIN december_2002_dates d ON cs.CS_SOLD_DATE_SK = d.D_DATE_SK
     INNER JOIN us_customers uc ON cs.CS_BILL_CUSTOMER_SK = uc.C_CUSTOMER_SK) as total_orders,
    '712831' as expected_count,
    CASE
        WHEN (SELECT COUNT(DISTINCT SS_TICKET_NUMBER) FROM SNOWFLAKE_SAMPLE_DATA.TPCDS_SF10TCL.STORE_SALES ss
              INNER JOIN december_2002_dates d ON ss.SS_SOLD_DATE_SK = d.D_DATE_SK
              INNER JOIN us_customers uc ON ss.SS_CUSTOMER_SK = uc.C_CUSTOMER_SK) +
             (SELECT COUNT(DISTINCT WS_ORDER_NUMBER) FROM SNOWFLAKE_SAMPLE_DATA.TPCDS_SF10TCL.WEB_SALES ws
              INNER JOIN december_2002_dates d ON ws.WS_SOLD_DATE_SK = d.D_DATE_SK
              INNER JOIN us_customers uc ON ws.WS_BILL_CUSTOMER_SK = uc.C_CUSTOMER_SK) +
             (SELECT COUNT(DISTINCT CS_ORDER_NUMBER) FROM SNOWFLAKE_SAMPLE_DATA.TPCDS_SF10TCL.CATALOG_SALES cs
              INNER JOIN december_2002_dates d ON cs.CS_SOLD_DATE_SK = d.D_DATE_SK
              INNER JOIN us_customers uc ON cs.CS_BILL_CUSTOMER_SK = uc.C_CUSTOMER_SK) = 712831
        THEN 'PASS'
        ELSE 'FAIL'
    END as validation_status;
